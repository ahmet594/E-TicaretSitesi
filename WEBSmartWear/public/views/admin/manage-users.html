<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kullanıcıları Yönet - Admin Paneli - SmartWear</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div id="navbar-container"></div>

    <main class="admin-container">
        <div class="admin-sidebar">
            <div class="admin-profile">
                <i class="fas fa-user-shield"></i>
                <h3>Admin Paneli</h3>
            </div>
            <nav class="admin-nav">
                <ul>
                    <li><a href="/views/admin/dashboard.html"><i class="fas fa-tachometer-alt"></i> Ana Panel</a></li>
                    <li><a href="/views/admin/add-product.html"><i class="fas fa-plus-circle"></i> Ürün Ekle</a></li>
                    <li><a href="/views/admin/manage-products.html"><i class="fas fa-box"></i> Ürünleri Yönet</a></li>
                    <li class="active"><a href="/views/admin/manage-users.html"><i class="fas fa-users"></i> Kullanıcıları Yönet</a></li>
                </ul>
            </nav>
            <div class="admin-logout">
                <button id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</button>
            </div>
        </div>
        
        <div class="admin-content">
            <div class="admin-header">
                <h1>Kullanıcıları Yönet</h1>
                <p id="admin-date">Tarih: <span></span></p>
            </div>
            
            <div class="filter-controls">
                <div class="search-box">
                    <input type="text" id="user-search" placeholder="Kullanıcı ara...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="filter-options">
                    <select id="role-filter">
                        <option value="">Tüm Roller</option>
                        <option value="user">Kullanıcı</option>
                        <option value="admin">Admin</option>
                    </select>
                    
                    <select id="sort-by">
                        <option value="newest">En Yeni Üye</option>
                        <option value="oldest">En Eski Üye</option>
                        <option value="name-asc">İsim (A-Z)</option>
                        <option value="name-desc">İsim (Z-A)</option>
                    </select>
                </div>
            </div>
            
            <div class="users-container">
                <table class="admin-table users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>İsim</th>
                            <th>E-posta</th>
                            <th>Rol</th>
                            <th>Kayıt Tarihi</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- Kullanıcılar API'den alınarak burada listelenecek -->
                        <tr>
                            <td colspan="6" class="loading-message">
                                <i class="fas fa-spinner fa-spin"></i> Kullanıcılar yükleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination">
                <button id="prev-page" disabled><i class="fas fa-chevron-left"></i> Önceki</button>
                <div id="page-numbers">
                    <span class="current-page">1</span> / <span id="total-pages">1</span>
                </div>
                <button id="next-page">Sonraki <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </main>

    <!-- Kullanıcı Detay/Düzenleme Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Kullanıcı Düzenle</h2>
                <button class="close-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    
                    <div class="form-group">
                        <label for="edit-user-name">İsim</label>
                        <input type="text" id="edit-user-name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-user-email">E-posta</label>
                        <input type="email" id="edit-user-email" name="email" required readonly>
                        <small>E-posta adresi değiştirilemez</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-user-role">Rol</label>
                            <select id="edit-user-role" name="role" required>
                                <option value="user">Kullanıcı</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-user-status">Durum</label>
                            <select id="edit-user-status" name="status">
                                <option value="active">Aktif</option>
                                <option value="inactive">Pasif</option>
                                <option value="banned">Yasaklı</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-user-address">Adres</label>
                        <textarea id="edit-user-address" name="address" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Şifre Sıfırlama</label>
                        <button type="button" id="reset-password-btn" class="secondary-btn"><i class="fas fa-key"></i> Şifre Sıfırlama E-postası Gönder</button>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="delete-user-btn" class="delete-btn"><i class="fas fa-user-times"></i> Kullanıcıyı Sil</button>
                        <button type="submit" class="submit-btn"><i class="fas fa-save"></i> Değişiklikleri Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Silme Onay Modalı -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Kullanıcıyı Sil</h2>
                <button class="close-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p>Bu kullanıcıyı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz ve kullanıcının tüm verileri silinecektir.</p>
                <div class="modal-actions">
                    <button id="cancel-delete" class="cancel-btn"><i class="fas fa-times"></i> İptal</button>
                    <button id="confirm-delete" class="delete-btn"><i class="fas fa-user-times"></i> Kullanıcıyı Sil</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yeni Kullanıcı Ekle Modalı -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Yeni Kullanıcı Ekle</h2>
                <button class="close-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="add-user-form">
                    <div class="form-group">
                        <label for="new-user-name">İsim</label>
                        <input type="text" id="new-user-name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-user-email">E-posta</label>
                        <input type="email" id="new-user-email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-user-password">Şifre</label>
                        <input type="password" id="new-user-password" name="password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-user-role">Rol</label>
                        <select id="new-user-role" name="role" required>
                            <option value="user">Kullanıcı</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="cancel-btn close-modal"><i class="fas fa-times"></i> İptal</button>
                        <button type="submit" class="submit-btn"><i class="fas fa-plus"></i> Kullanıcı Ekle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>

    <!-- Floating Action Button -->
    <button id="add-user-btn" class="floating-btn">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/js/components/components-loader.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Admin erişim kontrolü
            const userRole = localStorage.getItem('userRole');
            if (userRole !== 'admin') {
                window.location.href = '/views/index.html';
                return;
            }
            
            // Tarih bilgisini güncelle
            updateDateDisplay();
            
            // Sayfalama değişkenleri
            let currentPage = 1;
            let totalPages = 1;
            let pageSize = 10;
            
            // Filtreleme değişkenleri
            let searchQuery = '';
            let roleFilter = '';
            let sortBy = 'newest';
            
            // Kullanıcıları yükle
            loadUsers();
            
            // Arama kutusu
            const searchInput = document.getElementById('user-search');
            const searchBtn = document.getElementById('search-btn');
            
            searchBtn.addEventListener('click', function() {
                searchQuery = searchInput.value.trim();
                currentPage = 1;
                loadUsers();
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchQuery = searchInput.value.trim();
                    currentPage = 1;
                    loadUsers();
                }
            });
            
            // Rol filtresi
            const roleSelect = document.getElementById('role-filter');
            roleSelect.addEventListener('change', function() {
                roleFilter = this.value;
                currentPage = 1;
                loadUsers();
            });
            
            // Sıralama
            const sortBySelect = document.getElementById('sort-by');
            sortBySelect.addEventListener('change', function() {
                sortBy = this.value;
                loadUsers();
            });
            
            // Sayfalama kontrolleri
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            
            prevPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadUsers();
                }
            });
            
            nextPageBtn.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadUsers();
                }
            });
            
            // Modal elemanları
            const userModal = document.getElementById('user-modal');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const addUserModal = document.getElementById('add-user-modal');
            const closeModalBtns = document.querySelectorAll('.close-modal');
            
            // Modal kapatma düğmeleri
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    userModal.style.display = 'none';
                    deleteConfirmModal.style.display = 'none';
                    addUserModal.style.display = 'none';
                });
            });
            
            // Modal dışına tıklayınca kapat
            window.addEventListener('click', function(e) {
                if (e.target === userModal) {
                    userModal.style.display = 'none';
                }
                if (e.target === deleteConfirmModal) {
                    deleteConfirmModal.style.display = 'none';
                }
                if (e.target === addUserModal) {
                    addUserModal.style.display = 'none';
                }
            });
            
            // Kullanıcı düzenleme formu
            const editUserForm = document.getElementById('edit-user-form');
            
            editUserForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const userId = document.getElementById('edit-user-id').value;
                
                try {
                    const formData = new FormData(this);
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(Object.fromEntries(formData))
                    });
                    
                    if (!response.ok) {
                        throw new Error('Kullanıcı güncellenirken bir hata oluştu');
                    }
                    
                    alert('Kullanıcı başarıyla güncellendi');
                    userModal.style.display = 'none';
                    loadUsers();
                } catch (error) {
                    alert(`Hata: ${error.message}`);
                    console.error('Kullanıcı güncelleme hatası:', error);
                }
            });
            
            // Kullanıcı silme düğmesi
            const deleteUserBtn = document.getElementById('delete-user-btn');
            
            deleteUserBtn.addEventListener('click', function() {
                userModal.style.display = 'none';
                deleteConfirmModal.style.display = 'block';
            });
            
            // Silme işlemini iptal et
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            
            cancelDeleteBtn.addEventListener('click', function() {
                deleteConfirmModal.style.display = 'none';
                userModal.style.display = 'block';
            });
            
            // Silme işlemini onayla
            const confirmDeleteBtn = document.getElementById('confirm-delete');
            
            confirmDeleteBtn.addEventListener('click', async function() {
                const userId = document.getElementById('edit-user-id').value;
                
                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Kullanıcı silinirken bir hata oluştu');
                    }
                    
                    alert('Kullanıcı başarıyla silindi');
                    deleteConfirmModal.style.display = 'none';
                    loadUsers();
                } catch (error) {
                    alert(`Hata: ${error.message}`);
                    console.error('Kullanıcı silme hatası:', error);
                }
            });
            
            // Şifre sıfırlama butonu
            const resetPasswordBtn = document.getElementById('reset-password-btn');
            
            resetPasswordBtn.addEventListener('click', async function() {
                const userId = document.getElementById('edit-user-id').value;
                const userEmail = document.getElementById('edit-user-email').value;
                
                try {
                    const response = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId, email: userEmail })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Şifre sıfırlama e-postası gönderilirken bir hata oluştu');
                    }
                    
                    alert(`Şifre sıfırlama e-postası ${userEmail} adresine gönderildi`);
                } catch (error) {
                    alert(`Hata: ${error.message}`);
                    console.error('Şifre sıfırlama hatası:', error);
                }
            });
            
            // Yeni kullanıcı ekleme butonu
            const addUserBtn = document.getElementById('add-user-btn');
            
            addUserBtn.addEventListener('click', function() {
                addUserModal.style.display = 'block';
            });
            
            // Yeni kullanıcı ekleme formu
            const addUserForm = document.getElementById('add-user-form');
            
            addUserForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const formData = new FormData(this);
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(Object.fromEntries(formData))
                    });
                    
                    if (!response.ok) {
                        throw new Error('Kullanıcı eklenirken bir hata oluştu');
                    }
                    
                    alert('Kullanıcı başarıyla eklendi');
                    addUserModal.style.display = 'none';
                    this.reset();
                    loadUsers();
                } catch (error) {
                    alert(`Hata: ${error.message}`);
                    console.error('Kullanıcı ekleme hatası:', error);
                }
            });
            
            // Kullanıcıları API'den alma
            async function loadUsers() {
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = `
                    <tr>
                        <td colspan="6" class="loading-message">
                            <i class="fas fa-spinner fa-spin"></i> Kullanıcılar yükleniyor...
                        </td>
                    </tr>
                `;
                
                try {
                    // API'ye istek atmadan önce tokeni kontrol et
                    if (!localStorage.getItem('token')) {
                        throw new Error('Oturum süresi dolmuş');
                    }
                    
                    // Filtre parametrelerini hazırla
                    const params = new URLSearchParams({
                        page: currentPage,
                        limit: pageSize
                    });
                    
                    if (searchQuery) params.append('search', searchQuery);
                    if (roleFilter) params.append('role', roleFilter);
                    if (sortBy) params.append('sort', sortBy);
                    
                    const response = await fetch(`/api/users?${params.toString()}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Kullanıcılar yüklenirken bir hata oluştu');
                    }
                    
                    const data = await response.json();
                    const users = data.users || data;
                    
                    // Sayfalama bilgisini güncelle
                    totalPages = data.totalPages || 1;
                    document.getElementById('total-pages').textContent = totalPages;
                    document.querySelector('.current-page').textContent = currentPage;
                    
                    // Sayfalama butonlarını güncelle
                    prevPageBtn.disabled = currentPage <= 1;
                    nextPageBtn.disabled = currentPage >= totalPages;
                    
                    // Kullanıcı listesini oluştur
                    if (users.length === 0) {
                        usersList.innerHTML = `
                            <tr>
                                <td colspan="6" class="no-results">
                                    <i class="fas fa-info-circle"></i> Kullanıcı bulunamadı.
                                </td>
                            </tr>
                        `;
                    } else {
                        let html = '';
                        
                        users.forEach(user => {
                            const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
                            const roleText = user.role === 'admin' ? 'Admin' : 'Kullanıcı';
                            const createdAt = new Date(user.createdAt).toLocaleDateString('tr-TR');
                            
                            html += `
                                <tr data-id="${user._id}">
                                    <td>${user._id.substring(0, 8)}...</td>
                                    <td>${user.name}</td>
                                    <td>${user.email}</td>
                                    <td><span class="role ${roleClass}">${roleText}</span></td>
                                    <td>${createdAt}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="edit-user" data-id="${user._id}"><i class="fas fa-edit"></i></button>
                                            <button class="delete-user" data-id="${user._id}"><i class="fas fa-user-times"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        usersList.innerHTML = html;
                        
                        // Düzenleme ve silme butonlarına olay dinleyicileri ekle
                        document.querySelectorAll('.edit-user').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const userId = this.getAttribute('data-id');
                                openUserModal(userId);
                            });
                        });
                        
                        document.querySelectorAll('.delete-user').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const userId = this.getAttribute('data-id');
                                document.getElementById('edit-user-id').value = userId;
                                deleteConfirmModal.style.display = 'block';
                            });
                        });
                    }
                } catch (error) {
                    usersList.innerHTML = `
                        <tr>
                            <td colspan="6" class="error-message">
                                <i class="fas fa-exclamation-triangle"></i> Hata: ${error.message}
                            </td>
                        </tr>
                    `;
                    console.error('Kullanıcıları yükleme hatası:', error);
                }
            }
            
            // Kullanıcı düzenleme modalını aç
            async function openUserModal(userId) {
                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Kullanıcı bilgileri alınamadı');
                    }
                    
                    const user = await response.json();
                    
                    // Form alanlarını doldur
                    document.getElementById('edit-user-id').value = user._id;
                    document.getElementById('edit-user-name').value = user.name;
                    document.getElementById('edit-user-email').value = user.email;
                    document.getElementById('edit-user-role').value = user.role || 'user';
                    document.getElementById('edit-user-status').value = user.status || 'active';
                    document.getElementById('edit-user-address').value = user.address || '';
                    
                    // Modalı göster
                    userModal.style.display = 'block';
                } catch (error) {
                    alert(`Hata: ${error.message}`);
                    console.error('Kullanıcı bilgilerini alma hatası:', error);
                }
            }
        });
        
        // Tarih bilgisini güncelle
        function updateDateDisplay() {
            const dateElement = document.querySelector('#admin-date span');
            if (dateElement) {
                const now = new Date();
                dateElement.textContent = now.toLocaleDateString('tr-TR');
            }
        }
    </script>
</body>
</html> 